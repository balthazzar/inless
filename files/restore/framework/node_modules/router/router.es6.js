
var express = typeof window == 'undefined' ? require('ex'+'press') : null;

var React = require('react/addons');
var rRouter = require('react-router');
var Route = rRouter.Route;
var NotFoundRoute = rRouter.NotFoundRoute;

import Logger from 'logger';

var logger = Logger.getLogger('router');


import PreData from 'preData';



var render = function(layout, params) {
	var escapeHtml = function(text) {
		var map = {
			'&': '&amp;',
			'<': '&lt;',
			'>': '&gt;',
			'"': '&quot;',
			"'": '&#039;'
		};
		return text.replace(/[&<>"']/g, function(m) { return map[m]; });
	}
	for(var _i in params) {
		var i = params[_i];
		layout = layout.split("%"+_i+"%").join(i);
		layout = layout.split("#"+_i+"#").join(escapeHtml(i));
	}
	return layout.replace(/(\n\s+)/gi, "").replace(/(\n)/gi, "");
};


class Router {
	constructor() {
		this.routes = [];
	}
	add(path, handler, status, title, express) {
		this.routes.push({
			path: path||'/',
			handler: handler||null,
			status: status||null,
			title: title||':)',
			express: express||function(ret) {ret.end()}
		});
	}
	rxReact(layout) {
		layout['mixins'] = [{
			getYield() {
				return rRouter.RouteHandler;
			}
		}];
		var Layout = React.createClass(layout);
		let reactElements = [Route, {handler: Layout, location: "history"}];
		this.routes.forEach((e)=> {
			reactElements.push(React.createElement(Route, {path: e.path, handler: e.handler}));
		});
		var routes = React.createElement.apply(React, reactElements);
		return routes;
	}
	exec(template, Layout, config) {
		var router = express.Router();
		var mode = require('start'+'mode');
		var browserify = require('browserify'+'-middleware');
		var appConfig = require('con'+'figs')('application');
		router.use('/api/session', (request, response, next)=> {
			response.json(request.session);
		});
		router.use(config.browser.bundle || '/bundle.js', browserify(
			'./framework/browser.js', {
			transform: [
				"babelify",
				"require-globify"
			],
			stage: 0,
			precompile: mode == 'production',
			gzip: mode == 'production',
			minify: mode == 'production',
			cache: mode == 'production'
		}));
		var routes = this.rxReact(Layout);
		var preData = new PreData(this.routes);
		router.use(preData.router);
		router.use((request, response, next)=> {
			if(!request.__ret) {
				logger.warn(request.path);
				response.status(404);
				response.end('Not found 404');
				return;
			}
			var {req, res, status} = request.__ret||{};
			var relStatus = request.session.account.status;
			if(status < relStatus) {
				logger.warn(request.path);
				response.status(403);
				response.end('Error 403');
				return;
			}
			// logger.trace('==============');
			// logger.trace(request.path);
			// logger.trace(res.data);
			// logger.trace('==============');
			var dataId = preData.create(res.data);
			var url = `${request.path}?dataId=${dataId}`;
			rRouter.run(routes, url, function(Root) {
				var content = React.renderToString(
					React.createElement(Root, null)
				);
				var xScript = (function() {
					var ret = `<script>var ___preData = ${!request.query.script ? JSON.stringify(preData.remove(dataId)) : '{}'};
					var ___session = ${!request.session ? '{}' : JSON.stringify(request.session)};</script>
					<script type="text/javascript" charset="utf-8" src="${config.browser.bundle||'/bundle.js'}"></script>`;
					return ret;
				})();
				var xStyle = (function() {
					var ret = `
					<link rel="stylesheet" type="text/css" href="${appConfig.style.bundleUrl||'/bundle.css'}"></link>
					`;
					return ret;
				})();
				response.end(render(template, {
					title: res.title||'',
					rootSelector: appConfig.style.rootSelector ? appConfig.style.rootSelector.replace(/\.|\#/ig, '') : 'application',
					script: xScript,
					style: xStyle,
					yield: content||''
				}));
			});
		});
		return router;
	}
}



module.exports = Router;
