'use strict';

var React = require('react/addons');

var Router = require('react-router');

var Logger = require('logger');
var logger = Logger.getLogger('reactRoute');

var client = function() {
	return {
		getInitialState: function() {
			var $ = this;
			var form = new FormData();
			if(!window.topopen) {
				window.topopen = true;
				return window.___preData;
			}
			console.log('>>url', window.location.pathname+window.location.search);
			form.append('url', window.location.pathname+window.location.search);
			form.append('body', JSON.stringify({}));
			fetch('/preData', {
				credentials: 'include',
				method: 'post',
				body: form
			}).then(function(response) {
				return response.json().then(function(data) {
					$.setState(data.preData);
				});
			}).catch(function(error) {
				console.error(error);
			});
			return {};
		}
	};
}

var server = function() {
	var preData = require('preData'+'/get.js');
	return {
		getInitialState: function() {
			var did = this.props.query.dataId;
			var data = preData(did);
			// console.log('~~~~~~~~~~~~~~~~~~');
			// console.log(data);
			// console.log('~~~~~~~~~~~~~~~~~~');
			var onAir = this.onAir||function(){};
			//onAir();
			return data;
		}
	};
}

var dataMixin = typeof window == 'undefined' ? server() : client();

module.exports = function(obj) {
	obj['mixins'] = [dataMixin, Router.Navigation];
	return React.createClass(obj);
};
